<!doctype html>
<html lang="he" dir="rtl" class="overflow-x-hidden">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="theme-color" content="#0f172a" />
    <title>×¦×™×™×“ ×”××¦×™××•×ª | Reality Hunter</title>

    <!-- SEO Meta Tags -->
    <meta
      name="description"
      content="×¦×™×™×“ ×”××¦×™××•×ª - ×”××§×•× ×©×œ×š ×œ××¦×•× ××ª ×”××›×¨×–×™× ×•×”×¢×¡×§××•×ª ×”××©×ª×œ××•×ª ×‘×™×•×ª×¨. ×‘×•××• ×œ×—×¤×©, ×œ×”×©×•×•×ª ×•×œ×–×›×•×ª!"
    />
    <meta
      name="keywords"
      content="××›×¨×–×™×, ×¢×¡×§××•×ª, ×¦×™×™×“ ××¦×™××•×ª, ×§× ×™×•×ª, ×›×•× ×¡ × ×›×¡×™×"
    />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- Tailwind CSS (via CDN for basic structure) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Customization & Custom CSS -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Heebo", "sans-serif"],
            },
            colors: {
              brand: {
                50: "#f0fdfa",
                100: "#ccfbf1",
                400: "#2dd4bf",
                500: "#14b8a6",
                600: "#0d9488",
                900: "#134e4a",
              },
            },
          },
        },
      };
    </script>

    <style>
      body {
        background-color: #0f172a; /* Slate 900 */
        color: #f8fafc; /* Slate 50 */
        -webkit-tap-highlight-color: transparent;
      }

      /* Glassmorphism Classes */
      .glass-header {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .card-glass {
        background: rgba(30, 41, 59, 0.6);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow:
          0 10px 15px -3px rgba(0, 0, 0, 0.2),
          0 4px 6px -2px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .card-glass:hover {
        border-color: rgba(45, 212, 191, 0.3); /* brand-400 with opacity */
        box-shadow: 0 10px 25px -3px rgba(20, 184, 166, 0.15);
        transform: translateY(-4px);
      }

      /* Ambient Glows */
      .glow-blob {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        z-index: -1;
        opacity: 0.4;
        pointer-events: none;
      }

      .glow-1 {
        top: -10%;
        right: -5%;
        width: 400px;
        height: 400px;
        background: radial-gradient(
          circle,
          rgba(20, 184, 166, 0.3) 0%,
          rgba(15, 23, 42, 0) 70%
        );
      }

      .glow-2 {
        bottom: 10%;
        left: -10%;
        width: 500px;
        height: 500px;
        background: radial-gradient(
          circle,
          rgba(99, 102, 241, 0.2) 0%,
          rgba(15, 23, 42, 0) 70%
        );
      }

      /* Mobile specific adjustments to ensure layout doesn't break on Safari/Chrome */
      @supports (-webkit-touch-callout: none) {
        .min-h-screen {
          min-height: -webkit-fill-available;
        }
      }
    </style>
  </head>
  <body
    class="min-h-screen flex flex-col antialiased selection:bg-brand-500 selection:text-white overflow-x-hidden"
  >
    <!-- Ambient Background Lighting -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden z-0">
      <div class="glow-blob glow-1"></div>
      <div class="glow-blob glow-2"></div>
    </div>

    <!-- Header -->
    <header
      class="glass-header text-white sticky top-0 z-50 w-full transition-all duration-300"
      id="main-header"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
          <!-- Logo & Brand Name -->
          <div class="flex items-center gap-3">
            <div
              class="w-12 h-12 rounded-2xl bg-gradient-to-br from-brand-400 to-indigo-600 flex items-center justify-center shadow-lg shadow-brand-500/20"
            >
              <!-- Search/Radar Icon for 'Hunter' -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-white"
              >
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
            <h1 class="text-2xl font-extrabold tracking-tight">
              <span class="text-white">×¦×™×™×“ </span
              ><span
                class="bg-clip-text text-transparent bg-gradient-to-r from-brand-400 to-indigo-400"
                >×”××¦×™××•×ª</span
              >
            </h1>
          </div>

          <!-- Desktop Navigation -->
          <nav class="hidden md:flex items-center space-x-8 space-x-reverse">
            <button id="toggleMapBtn" class="text-white font-medium hover:text-brand-400 transition-colors bg-slate-800/50 px-4 py-1.5 rounded-full border border-slate-700">×ª×¦×•×’×ª ××¤×” ğŸ—ºï¸</button>
            <a
              href="#"
              class="text-white font-medium hover:text-brand-400 transition-colors"
              >×¨××©×™</a
            >
            <a
              href="mailto:chiprut20@gmail.com"
              class="text-slate-300 font-medium hover:text-white transition-colors"
              >×¦×•×¨ ×§×©×¨</a
            >
          </nav>

          <!-- Mobile Menu Button -->
          <div class="md:hidden flex items-center">
            <button
              id="mobile-menu-btn"
              aria-label="×ª×¤×¨×™×˜"
              class="text-slate-300 hover:text-white p-2 focus:outline-none"
            >
              <svg
                class="h-7 w-7"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content Section -->
    <main
      class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16 relative z-10 w-full overflow-hidden"
    >
      <!-- Welcome / Hero Header -->
      <div class="mb-10 text-center flex flex-col items-center">
        <h2
          class="text-4xl md:text-5xl lg:text-5xl font-extrabold text-white mb-4 tracking-tight"
        >
          ×”××›×¨×–×™×
          <span
            class="text-transparent bg-clip-text bg-gradient-to-l from-indigo-400 to-brand-400"
            >×”×—××™× ×‘×™×•×ª×¨</span
          >
        </h2>
        <p class="text-lg md:text-xl text-slate-400 max-w-3xl leading-relaxed">
          ×‘×¨×•×›×™× ×”×‘××™× ×œ××¢×¨×›×ª <strong>×¦×™×™×“ ×”××¦×™××•×ª</strong>. 
          ×× ×• ××•×¡×¤×™× ×¢×‘×•×¨×›× ×¢×¡×§××•×ª ××©×ª×œ××•×ª ×™×©×™×¨×•×ª ××××’×¨×™ ×”×××©×œ×” (×¨×›×‘×™ ×××©×œ×” ×××™× ×”×œ ×”×¨×›×‘, ××©×˜×¨×”/××›×¡, ×¨×›×‘×™ ×•×¦×™×•×“ ×”×•×¦××” ×œ×¤×•×¢×œ ×•× ×“×œ"×Ÿ ×¢×–×•×‘ ××”××¤×•×˜×¨×•×¤×•×¡ ×”×›×œ×œ×™).
          ×”× ×ª×•× ×™× × ×©××‘×™× ×•××ª×¢×“×›× ×™× <strong>××“×™ ×™×•× ×‘×©×¢×” 08:00 ×‘×‘×•×§×¨</strong> ×›×“×™ ×œ×”×‘×˜×™×— ×©×ª××™×“ ×ª×”×™×• ×¦×¢×“ ××—×“ ×œ×¤× ×™ ×›×•×œ×!
        </p>
      </div>

      <!-- Controls (Filter & Sort) -->
      <div class="mb-8 flex flex-col md:flex-row gap-4 items-center justify-between bg-slate-800/40 p-4 rounded-2xl border border-slate-700/50 backdrop-blur-sm">
        <div class="flex flex-wrap gap-2 w-full md:w-auto" id="filter-buttons">
          <button class="filter-btn px-4 py-2 rounded-xl bg-brand-500 text-white font-medium text-sm transition-colors" data-filter="all">×”×›×œ</button>
          <button class="filter-btn px-4 py-2 rounded-xl bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium text-sm transition-colors" data-filter="car">×¨×›×‘×™×</button>
          <button class="filter-btn px-4 py-2 rounded-xl bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium text-sm transition-colors" data-filter="real_estate">× ×“×œ"×Ÿ</button>
          <button class="filter-btn px-4 py-2 rounded-xl bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium text-sm transition-colors" data-filter="equipment">×¦×™×•×“ (×”×•×¦×œ"×¤)</button>
        </div>
        <div class="flex items-center gap-3 w-full md:w-auto">
          <label class="text-slate-400 text-sm whitespace-nowrap hidden sm:block">×¡× ×Ÿ ×œ×¤×™:</label>
          <select id="price-sort" class="bg-slate-900 border border-slate-700 text-white text-sm rounded-xl focus:ring-brand-500 focus:border-brand-500 block w-full p-2.5 outline-none">
            <option value="default">×××œ×™×¥ ××”×—×“×© ×œ×™×©×Ÿ</option>
            <option value="cheap">××”×–×•×œ ×œ×™×§×¨</option>
            <option value="expensive">××”×™×§×¨ ×œ×–×•×œ</option>
            <option value="profit">××—×•×– ×¨×•×•×— ×¤×•×˜× ×¦×™××œ×™</option>
          </select>
        </div>
      </div>

      <!-- Deals Grid (Auction Placeholders) -->
      <section
        id="auctions-grid"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8"
      >
        <!-- Dynamic content will be injected here via JavaScript -->
        <div class="col-span-full text-center py-12 text-slate-400">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-brand-500 motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status">
                <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
            </div>
            <p class="mt-4 text-lg font-medium">×˜×•×¢×Ÿ ××›×¨×–×™×...</p>
        </div>
      </section>

      <!-- Map View (Hidden by default) -->
      <div id="mapContainer" class="hidden w-full h-[600px] rounded-3xl overflow-hidden shadow-2xl border border-slate-700/50 mt-8 relative z-0">
        <div id="map" class="w-full h-full z-0 relative"></div>
      </div>

      <!-- Deal Modal (Hidden by default) -->
      <div id="dealModal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 sm:p-6 opacity-0 transition-opacity duration-300">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="relative bg-slate-800 border border-slate-700 rounded-3xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl transform scale-95 transition-transform duration-300" id="modalContentPanel">
          <!-- Modal content injected via JS -->
        </div>
      </div>
    </main>

    <!-- Light Footer -->
    <footer
      class="border-t border-slate-800/80 bg-slate-900/50 mt-auto py-8 relative z-10"
    >
      <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-4"
      >
        <p class="text-slate-500 text-sm font-medium">
          &copy; 2026 ×¦×™×™×“ ×”××¦×™××•×ª. ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª.
        </p>
        <div class="flex gap-6">
          <a
            href="mailto:chiprut20@gmail.com"
            class="text-slate-500 hover:text-brand-400 transition-colors font-medium text-sm"
          >
            ×¦×•×¨ ×§×©×¨
          </a>
        </div>
      </div>
    </footer>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const grid = document.getElementById('auctions-grid');
        const mapContainer = document.getElementById('mapContainer');
        const toggleMapBtn = document.getElementById('toggleMapBtn');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const sortSelect = document.getElementById('price-sort');
        
        let allDeals = [];
        let currentFilter = 'all';
        let currentSort = 'default';
        let isMapVisible = false;
        let myMap = null;
        let mapMarkers = [];

        // Toggle Map View
        toggleMapBtn.addEventListener('click', () => {
          isMapVisible = !isMapVisible;
          if (isMapVisible) {
            grid.classList.add('hidden');
            mapContainer.classList.remove('hidden');
            toggleMapBtn.innerHTML = '×ª×¦×•×’×ª ×›×¨×˜×™×¡×™×•×ª ğŸ—‚ï¸';
            toggleMapBtn.classList.add('bg-brand-500');
            toggleMapBtn.classList.remove('bg-slate-800/50');
            
            if (!myMap) {
              // Initialize Map centered on Israel
              myMap = L.map('map').setView([31.5, 34.8], 7);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: 'Â© OpenStreetMap contributors'
              }).addTo(myMap);
            }
            // Give map time to render its container properly since it was hidden
            setTimeout(() => {
              myMap.invalidateSize();
              updateMapMarkers();
            }, 100);

          } else {
            grid.classList.remove('hidden');
            mapContainer.classList.add('hidden');
            toggleMapBtn.innerHTML = '×ª×¦×•×’×ª ××¤×” ğŸ—ºï¸';
            toggleMapBtn.classList.remove('bg-brand-500');
            toggleMapBtn.classList.add('bg-slate-800/50');
          }
        });

        async function geocodeAddress(address) {
          // Simple client-side mock geocoding based on common cities, as actual Nominatim API heavily rate-limits
          const citiesMap = {
            "×ª×œ ××‘×™×‘": [32.0853, 34.7818],
            "×™×¨×•×©×œ×™×": [31.7683, 35.2137],
            "×—×™×¤×”": [32.7940, 34.9896],
            "×‘××¨ ×©×‘×¢": [31.2518, 34.7913],
            "×¨××œ×”": [31.9272, 34.8643], // Ramla is in merkava
            "×—×•×œ×•×Ÿ": [32.0158, 34.7874],
            "× ×ª× ×™×”": [32.3215, 34.8532],
            "× ×™×¨ ×¦×‘×™": [31.9568, 34.8211]
          };
          for (const [city, coords] of Object.entries(citiesMap)) {
            if (address && address.includes(city)) return coords;
          }
          // Default fallback (somewhere central Israel randomly jittered)
          return [31.5 + (Math.random() * 1.5), 34.5 + (Math.random() * 0.5)];
        }

        async function updateMapMarkers() {
          if (!myMap || !isMapVisible) return;
          
          // Clear old markers
          mapMarkers.forEach(m => myMap.removeLayer(m));
          mapMarkers = [];
          
          // Use current filtered/sorted deals
          let activeDeals = getFilteredDeals();
          
          for (const deal of activeDeals) {
            let address = deal.city || deal.timeLeft || "Israel";
            let coords = await geocodeAddress(address);
            
            // Add slight random jitter so markers don't overlap exactly
            coords[0] += (Math.random() - 0.5) * 0.01;
            coords[1] += (Math.random() - 0.5) * 0.01;
            
            let iconColor = 'blue';
            if (deal.type === 'car') iconColor = 'green';
            if (deal.type === 'equipment') iconColor = 'red';
            
            let markerHtmlStyles = `
              background-color: ${iconColor};
              width: 2rem;
              height: 2rem;
              display: block;
              left: -1rem;
              top: -1rem;
              position: relative;
              border-radius: 3rem 3rem 0;
              transform: rotate(45deg);
              border: 1px solid #FFFFFF;
              box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.5);
            `;

            let icon = L.divIcon({
              className: "my-custom-pin",
              iconAnchor: [0, 24],
              labelAnchor: [-6, 0],
              popupAnchor: [0, -36],
              html: `<span style="${markerHtmlStyles}" />`
            });

            const marker = L.marker(coords, {icon: icon}).addTo(myMap);
            
            const formatter = new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 });
            marker.bindPopup(`
              <div dir="rtl" class="font-heebo p-1">
                <h4 class="font-bold text-sm mb-1">${deal.title}</h4>
                <p class="text-xs text-slate-600 mb-1">${address}</p>
                <p class="font-bold text-brand-600">${formatter.format(deal.openingPrice)}</p>
                <a href="${deal.link}" target="_blank" class="text-xs text-blue-500 underline mt-1 inline-block">×¦×¤×” ×‘×¤×¨×˜×™×</a>
              </div>
            `);
            mapMarkers.push(marker);
          }
        }
        
        function getFilteredDeals() {
          let filteredDeals = [...allDeals];
          if (currentFilter !== 'all') {
            filteredDeals = filteredDeals.filter(d => d.type === currentFilter);
          }
          if (currentSort === 'cheap') {
            filteredDeals.sort((a, b) => a.openingPrice - b.openingPrice);
          } else if (currentSort === 'expensive') {
            filteredDeals.sort((a, b) => b.openingPrice - a.openingPrice);
          } else if (currentSort === 'profit') {
            filteredDeals.sort((a, b) => {
              const profitA = ((a.marketValue - a.openingPrice) / (a.marketValue || 1));
              const profitB = ((b.marketValue - b.openingPrice) / (b.marketValue || 1));
              return profitB - profitA;
            });
          } else {
             filteredDeals.reverse();
          }
          return filteredDeals;
        }

        function renderDeals() {
          const dealsToRender = getFilteredDeals();
          grid.innerHTML = '';
          
          if (!dealsToRender || dealsToRender.length === 0) {
            grid.innerHTML = `<div class="col-span-full text-center p-12 bg-slate-800/40 rounded-3xl border border-slate-700/50 shadow-xl backdrop-blur-sm">
              <div class="w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
              </div>
              <h3 class="text-2xl font-bold text-white mb-2">×œ× × ××¦××• ×¢×¡×§××•×ª</h3>
              <p class="text-slate-400 max-w-md mx-auto">×›×¨×’×¢ ××™×Ÿ ××›×¨×–×™× ×¤×¢×™×œ×™× ×‘××¢×¨×›×ª ×©×ª×•×××™× ×œ×—×™×¤×•×© ×©×œ×š.</p>
            </div>`;
            return;
          }

          dealsToRender.forEach(deal => {
            const profitPercentage = Math.round(((deal.marketValue - deal.openingPrice) / (deal.marketValue || 1)) * 100) || 0;
            
            const formatter = new Intl.NumberFormat('he-IL', {
              style: 'currency',
              currency: 'ILS',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
            });
            
            const marketStr = formatter.format(deal.marketValue || 0);
            const openingStr = formatter.format(deal.openingPrice || 0);
            
            let badgeClass = 'bg-brand-500 border-brand-400';
            let iconSvg = '';
            let bgGradientClass = 'from-indigo-500/40 text-brand-500/40';
            let timeBadgeClass = 'bg-slate-900/80 text-white';

            if (deal.type === 'car') {
              badgeClass = 'bg-emerald-500 border-emerald-400';
              bgGradientClass = 'from-indigo-500/40 to-brand-500/40';
              iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>`;
            } else if (deal.type === 'real_estate') {
              badgeClass = 'bg-indigo-500 border-indigo-400';
              bgGradientClass = 'from-sky-500/40 to-indigo-500/40';
              iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`;
            } else if (deal.type === 'equipment') {
              badgeClass = 'bg-rose-500 border-rose-400';
              bgGradientClass = 'from-fuchsia-500/40 to-brand-500/40';
              timeBadgeClass = 'bg-rose-500/20 text-rose-300 border-rose-500/30 animate-pulse';
              iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-white"><circle cx="12" cy="12" r="7"></circle><polyline points="12 9 12 12 13.5 13.5"></polyline><path d="M16.51 17.35l-.35 3.83a2 2 0 0 1-2 1.82H9.83a2 2 0 0 1-2-1.82l-.35-3.83m.01-10.7l.35-3.83A2 2 0 0 1 9.83 1h4.35a2 2 0 0 1 2 1.82l.35 3.83"></path></svg>`;
            }
            
            let risksHTML = '';
            if (deal.risk_flags && deal.risk_flags.length > 0) {
              const riskBadges = deal.risk_flags.map(risk => `<span class="bg-red-500/20 text-red-400 border border-red-500/30 px-2 py-0.5 rounded text-xs font-bold">${risk}</span>`).join(' ');
              risksHTML = `<div class="mt-2 flex flex-wrap gap-1 mb-2">${riskBadges}</div>`;
            }
            
            const cardHTML = `
        <article class="card-glass rounded-3xl overflow-hidden flex flex-col h-full group">
          <div class="h-56 relative overflow-hidden bg-slate-800">
            <div class="absolute inset-0 bg-gradient-to-br ${bgGradientClass} group-hover:scale-105 transition-transform duration-500"></div>
            <div class="absolute inset-0 flex items-center justify-center opacity-50">
              ${iconSvg}
            </div>
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent z-10"></div>
            <div class="absolute top-4 right-4 z-20 ${badgeClass} text-white text-sm font-bold px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1.5 border border-white/20">
              <span dir="rtl">${profitPercentage}% ××ª×—×ª ×œ××—×™×¨×•×Ÿ</span>
            </div>
            <div class="absolute top-4 left-4 z-20 ${timeBadgeClass} text-xs font-semibold px-2.5 py-1 rounded-full border border-slate-700 backdrop-blur-md">
              ${deal.timeLeft}
            </div>
          </div>
          
          <div class="p-6 md:p-7 flex-grow flex flex-col gap-4">
            <h3 class="text-xl font-bold text-white group-hover:text-brand-400 transition-colors line-clamp-2 leading-snug">
              ${deal.title}
            </h3>
            ${risksHTML}
            
            <div class="bg-slate-800/50 rounded-2xl p-4 mt-auto border border-slate-700/50">
              <div class="flex justify-between items-center mb-2">
                <span class="text-slate-400 text-sm font-medium">×©×•×•×™ ×©×•×§ ××•×¢×¨×š:</span>
                <span class="text-slate-500 font-semibold line-through decoration-red-500/50 text-sm" dir="ltr">${marketStr}</span>
              </div>
              <div class="flex justify-between items-end">
                <span class="text-brand-400 text-sm font-bold flex items-center gap-1.5">
                  <span class="w-2 h-2 rounded-full bg-brand-500 animate-pulse"></span>
                  ××—×™×¨ ×¤×ª×™×—×”:
                </span>
                <span class="text-2xl font-extrabold text-white" dir="ltr">${openingStr}</span>
              </div>
            </div>
            
            <button onclick="openModal('${deal.id}')" class="w-full mt-2 bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-500 hover:to-brand-400 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg shadow-brand-500/25 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
              <span>×œ××“×¨×™×š ×”×’×©×”</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="rotate-180"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
            </button>
          </div>
        </article>
            `;
            grid.insertAdjacentHTML('beforeend', cardHTML);
          });
        }
        
        window.closeModal = function() {
          const modal = document.getElementById('dealModal');
          const panel = document.getElementById('modalContentPanel');
          modal.classList.remove('opacity-100');
          panel.classList.remove('scale-100');
          setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = ''; // Restore scrolling
          }, 300);
        };

        window.openModal = function(dealId) {
          const deal = allDeals.find(d => d.id === dealId);
          if (!deal) return;
          
          const modal = document.getElementById('dealModal');
          const panel = document.getElementById('modalContentPanel');
          
          let actionGuideHTML = '';
          if (deal.source.includes('××¨×›×‘×”') || deal.source.includes('××™× ×”×œ ×”×¨×›×‘')) {
            actionGuideHTML = `
              <li class="flex items-start gap-4">
                <div class="w-8 h-8 rounded-full bg-brand-500/20 text-brand-400 flex items-center justify-center font-bold flex-shrink-0 mt-0.5">1</div>
                <div><h4 class="font-bold text-white mb-1">×”×¨×©××” ×œ××›×¨×– ×”××§×•×•×Ÿ</h4><p class="text-sm text-slate-400">×”×™×›× ×¡×• ×œ××¢×¨×›×ª ×”××¨×›×‘×” ×”×××©×œ×ª×™×ª (× ×“×¨×©×ª ×”×–×“×”×•×ª ×œ××•××™×ª).</p></div>
              </li>
              <li class="flex items-start gap-4">
                <div class="w-8 h-8 rounded-full bg-brand-500/20 text-brand-400 flex items-center justify-center font-bold flex-shrink-0 mt-0.5">2</div>
                <div><h4 class="font-bold text-white mb-1">×ª×©×œ×•× ×¤×§×“×•×Ÿ ×”×¢×¨×‘×•×ª</h4><p class="text-sm text-slate-400">×™×© ×œ×©×œ× 10% ××©×•×•×™ ×”×”×¦×¢×” ×©××ª× ××’×™×©×™× ×›×“×™ ×œ×”×©×ª×ª×£.</p></div>
              </li>
              <li class="flex items-start gap-4">
                <div class="w-8 h-8 rounded-full bg-brand-500/20 text-brand-400 flex items-center justify-center font-bold flex-shrink-0 mt-0.5">3</div>
                <div><h4 class="font-bold text-white mb-1">×”×’×©×ª ×”××—×™×¨</h4><p class="text-sm text-slate-400">××•××œ×¥ ×œ×”×’×™×© ×¡×‘×™×‘ ×”-${new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(deal.openingPrice * 1.1)} (×ª××™×“ ×¢×“×™×£ ×œ×”×¦×™×¢ ×¡×›×•× "×œ× ×¢×’×•×œ").</p></div>
              </li>`;
          } else {
             actionGuideHTML = `
              <li class="flex items-start gap-4">
                <div class="w-8 h-8 rounded-full bg-brand-500/20 text-brand-400 flex items-center justify-center font-bold flex-shrink-0 mt-0.5">1</div>
                <div><h4 class="font-bold text-white mb-1">×§×¨×™××ª ×—×•×‘×¨×ª ×”××›×¨×–</h4><p class="text-sm text-slate-400">×•×•×“××• ×©××™×Ÿ ×—×¨×™×’×•×ª ×‘× ×¡×— ××• ×¤×•×œ×©×™× ×œ× ×›×¡ (Risk Analysis ×œ× ××™×ª×¨ ×‘×¨××ª ×”-AI ×”×¨××©×•× ×™×ª).</p></div>
              </li>
              <li class="flex items-start gap-4">
                <div class="w-8 h-8 rounded-full bg-brand-500/20 text-brand-400 flex items-center justify-center font-bold flex-shrink-0 mt-0.5">2</div>
                <div><h4 class="font-bold text-white mb-1">×”×¤×§×“×ª ×¢×¨×‘×•×ª ×‘× ×§××™×ª</h4><p class="text-sm text-slate-400">×™×© ×œ×’×©×ª ×œ×‘× ×§ ×•×œ×”×¤×™×§ ×¦'×§ ×‘× ×§××™ ×œ×¤×§×•×“×ª ×”××¤×•×˜×¨×•×¤×•×¡ ×”×›×œ×œ×™ / ×¨×"×™.</p></div>
              </li>
              <li class="flex items-start gap-4">
                <div class="w-8 h-8 rounded-full bg-brand-500/20 text-brand-400 flex items-center justify-center font-bold flex-shrink-0 mt-0.5">3</div>
                <div><h4 class="font-bold text-white mb-1">××¡×™×¨×” ×œ×ª×™×‘×”</h4><p class="text-sm text-slate-400">×™×© ×œ×©×œ×©×œ ××ª ×˜×•×¤×¡ ×”×”×¦×¢×” ×”××§×•×¨×™ ×•×”×¢×¨×‘×•×ª ×‘××¢×˜×¤×” ××˜×•××” ×‘×ª×™×‘×ª ×”××›×¨×–×™×.</p></div>
              </li>`;
          }
          
          let risksListHTML = '<p class="text-emerald-400 text-sm font-semibold flex items-center gap-1.5"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg> ×œ× ××•×ª×¨×• ××™×œ×•×ª ××–×”×¨×” ×§×¨×™×˜×™×•×ª (Risk Flags) ×‘×§×•×‘×¥ ×”×©×××•×ª.</p>';
          if (deal.risk_flags && deal.risk_flags.length > 0) {
            risksListHTML = `<div class="bg-red-500/10 border border-red-500/30 rounded-xl p-3"><p class="text-red-400 text-sm font-bold flex items-center gap-1.5 mb-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> ×¡×™×›×•× ×™× ××”×•×ª×™×™× ×©××•×ª×¨×• ×¢"×™ ×”-AI (×™×© ×œ×‘×—×•×Ÿ ×—×•×‘×¨×ª!):</p><ul class="list-disc pl-5 rtl:pr-5 rtl:pl-0 text-slate-300 text-sm space-y-1">` + 
                         deal.risk_flags.map(r => `<li>${r}</li>`).join('') + `</ul></div>`;
          }

          let marketStr = new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(deal.marketValue || 0);
          let openingStr = new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(deal.openingPrice || 0);
          let profitPercentage = Math.round(((deal.marketValue - deal.openingPrice) / (deal.marketValue || 1)) * 100) || 0;

          panel.innerHTML = `
            <div class="sticky top-0 bg-slate-800/95 backdrop-blur z-10 border-b border-slate-700 p-4 sm:p-6 flex justify-between items-start">
              <div class="pr-2">
                <span class="inline-block px-2.5 py-1 bg-slate-700 text-slate-300 text-xs font-bold rounded-lg mb-3">${deal.source}</span>
                <h2 class="text-2xl font-bold text-white leading-tight">${deal.title}</h2>
              </div>
              <button onclick="closeModal()" class="text-slate-400 hover:text-white bg-slate-700/50 hover:bg-slate-700 p-2 rounded-full transition-colors flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </div>
            
            <div class="p-4 sm:p-6 space-y-8">
              <!-- AI Executive Summary -->
              <section>
                <h3 class="text-lg font-bold text-white flex items-center gap-2 mb-4">
                  <span class="bg-brand-500/20 text-brand-400 p-1.5 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                  </span>
                  ×ª×§×¦×™×¨ ×›×œ×›×œ×™ (Benchmarking)
                </h3>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                  <div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-700/50">
                    <div class="text-sm text-slate-400 mb-1">×©×•×•×™ ××—×™×¨×•×Ÿ / ×©×•×§</div>
                    <div class="text-xl font-bold text-slate-300" dir="ltr">${marketStr}</div>
                  </div>
                  <div class="bg-slate-900/50 p-4 rounded-2xl border border-brand-500/30">
                    <div class="text-sm text-brand-400 mb-1">××—×™×¨ ×¤×ª×™×—×”</div>
                    <div class="text-xl font-bold text-white" dir="ltr">${openingStr}</div>
                  </div>
                  <div class="bg-emerald-500/10 p-4 rounded-2xl border border-emerald-500/30 col-span-2">
                    <div class="text-sm text-emerald-400 mb-1">×¤×•×˜× ×¦×™××œ ×¨×•×•×— ××©×•×¢×¨ (×œ×¤× ×™ ×”×©×‘×—×”)</div>
                    <div class="text-2xl font-extrabold text-emerald-400" dir="rtl">${profitPercentage}% ××ª×—×ª ×œ××—×™×¨×•×Ÿ <span class="text-sm font-medium opacity-80">(${new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(deal.marketValue - deal.openingPrice)})</span></div>
                  </div>
                </div>
              </section>

              <!-- Risk Analysis -->
              <section>
                <h3 class="text-lg font-bold text-white flex items-center gap-2 mb-4">
                  <span class="bg-rose-500/20 text-rose-400 p-1.5 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                  </span>
                  × ×™×ª×•×— ×¡×™×›×•× ×™× AI
                </h3>
                ${risksListHTML}
              </section>

              <!-- Actionable Guide -->
              <section>
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="bg-indigo-500/20 text-indigo-400 p-1.5 rounded-lg">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    </span>
                    ××™×š ××’×™×©×™×? (××¤×¡ ×‘×™×¨×•×§×¨×˜×™×”)
                  </h3>
                  <span class="text-xs text-slate-500 font-medium px-2 py-1 bg-slate-800 rounded-md border border-slate-700">××“×¨×™×š ×ª×”×œ×™×š ×›×œ×œ×™</span>
                </div>
                <p class="text-xs text-slate-400 mb-4">* ×”×©×œ×‘×™× ×”××¤×•×¨×˜×™× ××‘×•×¡×¡×™× ×¢×œ ×ª×”×œ×™×š ×”×”×’×©×” ×”×¡×˜× ×“×¨×˜×™ ×¢×‘×•×¨ ××›×¨×–×™ <strong>${deal.source}</strong>. ×™×© ×œ×¢×™×™×Ÿ ×ª××™×“ ×‘×—×•×‘×¨×ª ×”××›×¨×– ×”×¨×©××™×ª ×œ×§×‘×œ×ª ×”×”× ×—×™×•×ª ×•×”×˜×¤×¡×™× ×”××“×•×™×§×™×.</p>
                <ol class="space-y-6 relative before:absolute before:inset-y-0 before:right-4 before:w-0.5 before:bg-slate-700">
                  ${actionGuideHTML}
                </ol>
              </section>
            </div>
            
            <div class="sticky bottom-0 bg-slate-900/90 backdrop-blur border-t border-slate-700 p-4 sm:p-6 flex mt-4">
              <a href="${deal.link}" target="_blank" class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-3 px-6 rounded-xl text-center shadow-lg shadow-brand-500/25 transition-colors text-lg">
                ××¢×‘×¨ ×œ×¢××•×“ ×”××›×¨×– ×”×××©×œ×ª×™
              </a>
            </div>
          `;
          
          document.body.style.overflow = 'hidden'; // Prevent scrolling under modal
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          // Trigger reflow for animation
          void modal.offsetWidth;
          modal.classList.add('opacity-100');
          panel.classList.add('scale-100');
        };

        function applyFiltersAndSort() {
          renderDeals();
          if (isMapVisible) updateMapMarkers();
        }

        // Initialize UI Events
        filterButtons.forEach(btn => {
          btn.addEventListener('click', (e) => {
            filterButtons.forEach(b => {
              b.classList.remove('bg-brand-500', 'text-white');
              b.classList.add('bg-slate-700', 'text-slate-300');
            });
            e.target.classList.remove('bg-slate-700', 'text-slate-300');
            e.target.classList.add('bg-brand-500', 'text-white');
            
            currentFilter = e.target.getAttribute('data-filter');
            applyFiltersAndSort();
          });
        });

        sortSelect.addEventListener('change', (e) => {
          currentSort = e.target.value;
          applyFiltersAndSort();
        });

        try {
          // Append timestamp to prevent aggressive caching
          const response = await fetch('deals.json?t=' + new Date().getTime());
          if (!response.ok) throw new Error('Failed to fetch deals');
          
          const deals = await response.json();
          allDeals = deals || [];
          applyFiltersAndSort();
          
        } catch (error) {
          console.error('Error fetching deals:', error);
          grid.innerHTML = `<div class="col-span-full text-center p-8 bg-slate-800/50 rounded-2xl border border-slate-700">
            <p class="text-red-400 mb-2">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</p>
            <p class="text-slate-400 text-sm font-medium">×‘×“×§×• ×©- deals.json ×–××™×Ÿ ×•×©×”×¤×¨×•×™×§×˜ ×¤×•×¢×œ ×“×¨×š ×©×¨×ª.</p>
          </div>`;
        }
      });
    </script>
  </body>
</html>
